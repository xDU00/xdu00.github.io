---
import "katex/dist/katex.css";

import { siteConfig, profileConfig, umamiConfig, musicPlayerConfig, pioConfig } from "@/config";
import type { Favicon } from "@/types/config";
import { defaultFavicons } from "@constants/icon";
import { BREAKPOINT_LG } from "@/constants/breakpoints";
import {
    BANNER_HEIGHT,
    BANNER_HEIGHT_EXTEND,
    BANNER_HEIGHT_HOME,
    LIGHT_MODE,
    DARK_MODE,
    SYSTEM_MODE,
    PAGE_WIDTH,
} from "@constants/constants";
import { pathsEqual, url } from "@utils/url-utils";
import ConfigCarrier from "@components/ConfigCarrier.astro";
import MusicPlayer from "@components/widget/MusicPlayer.svelte";
import Pio from "@components/widget/Pio.svelte";
import "@styles/navbar.css";
import "@styles/banner.css";


interface Props {
    title?: string;
    banner?: string;
    description?: string;
    lang?: string;
    setOGTypeArticle?: boolean;
    postSlug?: string;
}

let { title, banner, description, lang, setOGTypeArticle, postSlug } = Astro.props;

// apply a class to the body element to decide the height of the banner, only used for initial page load
const isHomePage = pathsEqual(Astro.url.pathname, url("/"));

// defines global css variables
// why doing this in Layout instead of GlobalStyles: https://github.com/withastro/astro/issues/6728#issuecomment-1502203757
const configHue = siteConfig.themeColor.hue;

// 获取导航栏透明模式配置
const navbarTransparentMode =
    siteConfig.wallpaper.banner?.navbar?.transparentMode || "semi";
// 判断是否应该显示顶部高光效果（只在full和semifull模式下显示）
const shouldShowTopHighlight =
    navbarTransparentMode === "full" || navbarTransparentMode === "semifull";

// 获取默认banner图片的辅助函数
const getDefaultBanner = (): string => {
    const src = siteConfig.wallpaper.src;
    if (typeof src === "string") {
        return src;
    }
    if (Array.isArray(src)) {
        return src[0] || "";
    }
    if (src && typeof src === "object") {
        // 优先使用desktop，如果没有则使用mobile
        const desktopSrc = src.desktop;
        const mobileSrc = src.mobile;
        if (typeof desktopSrc === "string") {
            return desktopSrc;
        }
        if (Array.isArray(desktopSrc) && desktopSrc.length > 0) {
            return desktopSrc[0];
        }
        if (typeof mobileSrc === "string") {
            return mobileSrc;
        }
        if (Array.isArray(mobileSrc) && mobileSrc.length > 0) {
            return mobileSrc[0];
        }
    }
    return "";
};

const carouselConfig = siteConfig.wallpaper.carousel || { enable: false, interval: 6 };

// TODO don't use post cover as banner for now
banner = getDefaultBanner();

const enableBanner = siteConfig.wallpaper.mode === "banner";

let pageTitle: string;
if (title) {
    pageTitle = `${title} - ${siteConfig.title}`;
} else {
    pageTitle = siteConfig.subtitle
        ? `${siteConfig.title} - ${siteConfig.subtitle}`
        : siteConfig.title;
}

let ogImageUrl: string | undefined;
if (siteConfig.generateOgImages && postSlug) {
    ogImageUrl = new URL(`/og/${postSlug}.png`, Astro.site).toString();
}

const favicons: Favicon[] =
    siteConfig.favicon.length > 0 ? siteConfig.favicon : defaultFavicons;

// const siteLang = siteConfig.lang.replace('_', '-')
if (!lang) {
    lang = `${siteConfig.lang}`;
}
const siteLang = lang.replace("_", "-");

const bannerOffsetByPosition = {
    top: `${BANNER_HEIGHT_EXTEND}vh`,
    center: `${BANNER_HEIGHT_EXTEND / 2}vh`,
    bottom: "0",
};
const bannerOffset =
    bannerOffsetByPosition[siteConfig.wallpaper.position || "center"];

const umamiEnabled = umamiConfig.enabled || false;
const umamiScripts = umamiConfig.scripts || ""; // 获取Umami scripts配置
---

<!DOCTYPE html>
<html lang={siteLang} class="bg-[var(--page-bg)] text-[14px] md:text-[16px]"
      data-overlayscrollbars-initialize
>
    <head>
        <!-- 延迟加载优化 -->
        <script is:inline>
            // 使用 requestIdleCallback 延迟加载第三方脚本
            function loadAnalytics() {
                // Google Tag Manager
                (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-KRX3XGVH');
                // Clarity
                (function(c,l,a,r,i,t,y){c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);})(window, document, "clarity", "script", "tjr3vkhj8i");
            }
            // 在浏览器空闲时加载，或者在 3 秒后加载
            if ('requestIdleCallback' in window) {
                requestIdleCallback(loadAnalytics, { timeout: 3000 });
            } else {
                setTimeout(loadAnalytics, 3000);
            }
        </script>

        <title>{pageTitle}</title>

        <meta charset="UTF-8" />
        <meta name="description" content={description || pageTitle}>
        {siteConfig.keywords && siteConfig.keywords.length > 0 && (
            <meta name="keywords" content={siteConfig.keywords.join(', ')} />
        )}
        <meta name="author" content={profileConfig.name}>

        <meta property="og:site_name" content={siteConfig.title}>
        <meta property="og:url" content={Astro.url}>
        <meta property="og:title" content={pageTitle}>
        <meta property="og:description" content={description || pageTitle}>
        {ogImageUrl && <meta property="og:image" content={ogImageUrl} />}
        {
            setOGTypeArticle ? (
                <meta property="og:type" content="article" />
            ) : (
                <meta property="og:type" content="website" />
            )
        }

        <meta name="twitter:card" content="summary_large_image">
        <meta property="twitter:url" content={Astro.url}>
        <meta name="twitter:title" content={pageTitle}>
        <meta name="twitter:description" content={description || pageTitle}>

        <meta name="viewport" content="width=device-width" />
        <meta name="generator" content={Astro.generator} />
        {favicons.map(favicon => (
            <link rel="icon"
                  href={favicon.src.startsWith('/') ? url(favicon.src) : favicon.src}
                  sizes={favicon.sizes}
                  media={favicon.theme && `(prefers-color-scheme: ${favicon.theme})`}
            />
        ))}

        <!-- Set the theme before the page is rendered to avoid a flash -->
        <script is:inline define:vars={{BREAKPOINT_LG, LIGHT_MODE, DARK_MODE, SYSTEM_MODE, BANNER_HEIGHT_EXTEND, PAGE_WIDTH, configHue, defaultTheme: siteConfig.defaultTheme}}>
            // Load the theme from local storage
            const theme = localStorage.getItem('theme') || defaultTheme;
            // Apply the theme to the document
            let isDark = false;
            switch (theme) {
                case LIGHT_MODE:
                    document.documentElement.classList.remove('dark');
                    isDark = false;
                    break
                case DARK_MODE:
                    document.documentElement.classList.add('dark');
                    isDark = true;
                    break
                case SYSTEM_MODE:
                    if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
                        document.documentElement.classList.add('dark');
                        isDark = true;
                    } else {
                        document.documentElement.classList.remove('dark');
                        isDark = false;
                    }
            }
            const expressiveTheme = isDark ? "github-dark" : "github-light";
            document.documentElement.setAttribute("data-theme", expressiveTheme);
            // Load the hue from local storage
            const hue = localStorage.getItem('hue') || configHue;
            // Apply the hue to the document
            document.documentElement.style.setProperty('--hue', hue);
            // calculate the --banner-height-extend, which needs to be a multiple of 4 to avoid blurry text
            let offset = Math.floor(window.innerHeight * (BANNER_HEIGHT_EXTEND / 100));
            offset = offset - offset % 4;
            document.documentElement.style.setProperty('--banner-height-extend', `${offset}px`);
            // Initialize wallpaper mode using the proper initialization function
            setTimeout(() => {
                // Import and call the proper wallpaper initialization
                import('@utils/setting-utils').then(({ initWallpaperMode }) => {
                    initWallpaperMode();
                });
            }, 100);
            // Banner carousel initialization function
            window.initBannerCarousel = function() {
                const carousel = document.getElementById('banner-carousel');
                const carouselConfigData = carousel?.getAttribute('data-carousel-config');
                const carouselConfig = carouselConfigData ? JSON.parse(carouselConfigData) : {};
                const carouselItems = document.querySelectorAll('.carousel-item');
                // 根据屏幕尺寸过滤有效的轮播项
                const isMobile = window.innerWidth < BREAKPOINT_LG;
                const validItems = Array.from(carouselItems).filter(item => {
                    if (isMobile) {
                        // 移动端：只显示有mobile图片的项目
                        return item.querySelector('.block.lg\\:hidden');
                    } else {
                        // 桌面端：只显示有desktop图片的项目
                        return item.querySelector('.hidden.lg\\:block');
                    }
                });
                // Check if carousel is disabled but we have multiple images
                if (validItems.length > 1 && !carouselConfig?.enable) {
                    // Hide all images first
                    carouselItems.forEach((item, index) => {
                        item.classList.add('opacity-0', 'scale-110');
                        item.classList.remove('opacity-100', 'scale-100');
                    });
                    // Show random valid image
                    const randomIndex = Math.floor(Math.random() * validItems.length);
                    const randomItem = validItems[randomIndex];
                    randomItem.classList.add('opacity-100', 'scale-100');
                    randomItem.classList.remove('opacity-0', 'scale-110');
                    return;
                }
                if (validItems.length > 1 && carouselConfig?.enable) {
                    let currentIndex = 0;
                    const interval = carouselConfig?.interval || 6;
                    let carouselInterval;
                    let isPaused = false;
                    // 切换图片的函数 - 基于有效项目
                    function switchToSlide(index) {
                        // 隐藏当前图片
                        const currentItem = validItems[currentIndex];
                        currentItem.classList.remove('opacity-100', 'scale-100');
                        currentItem.classList.add('opacity-0', 'scale-110');
                        // 更新索引
                        currentIndex = index;
                        // 显示新图片
                        const nextItem = validItems[currentIndex];
                        nextItem.classList.add('opacity-100', 'scale-100');
                        nextItem.classList.remove('opacity-0', 'scale-110');
                    }
                    // 初始化：隐藏所有图片，只显示第一张有效图片
                    carouselItems.forEach((item) => {
                        item.classList.add('opacity-0', 'scale-110');
                        item.classList.remove('opacity-100', 'scale-100');
                    });
                    // 显示第一张有效图片
                    if (validItems.length > 0) {
                        validItems[0].classList.add('opacity-100', 'scale-100');
                        validItems[0].classList.remove('opacity-0', 'scale-110');
                    }
                    // 开始轮播的函数
                    function startCarousel() {
                        clearInterval(carouselInterval);
                        carouselInterval = setInterval(() => {
                            if (!isPaused) {
                                const nextIndex = (currentIndex + 1) % validItems.length;
                                switchToSlide(nextIndex);
                            }
                        }, interval * 1000);
                    }
                    // 鼠标悬停暂停（桌面端）
                    if (carousel) {
                        carousel.addEventListener('mouseenter', () => {
                            isPaused = true;
                            clearInterval(carouselInterval);
                        });
                        carousel.addEventListener('mouseleave', () => {
                            isPaused = false;
                            startCarousel();
                        });
                    }
                    // 开始自动轮播
                    startCarousel();
                }
            };
        </script>

        <!-- defines global css variables. This will be applied to <html> <body> and some other elements idk why -->
        <style define:vars={{
            configHue,
            'page-width': `${PAGE_WIDTH}rem`,
        }}></style>

        <slot name="head"></slot>

        <!-- Pio 看板娘样式 - 仅在启用时加载 -->
        {pioConfig.enable && <link rel="stylesheet" href="/pio/static/pio.css" />}

        <link rel="alternate" type="application/rss+xml" title={profileConfig.name} href={`${Astro.site}rss.xml`}/>

        <!-- Umami Analytics -->
        {umamiEnabled && umamiScripts && <Fragment set:html={umamiScripts} />}
</head>

    <body class=" min-h-screen " class:list={[{"lg:is-home": isHomePage, "enable-banner": enableBanner, "zen-maru-gothic-enabled": siteConfig.font.zenMaruGothic.enable, "hanalei-enabled": siteConfig.font.hanalei.enable}]}
          data-overlayscrollbars-initialize
    >
        <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-KRX3XGVH" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>

        <!-- 页面顶部渐变高光效果 - 只在full和semifull模式下显示 -->
        {shouldShowTopHighlight && <div class="top-gradient-highlight"></div>}
        <ConfigCarrier></ConfigCarrier>
        <slot />

        <!-- Music Player - 仅在启用时加载 -->
        {musicPlayerConfig.enable && <MusicPlayer client:load />}

        <!-- Pio 看板娘组件 -->
        <!-- 注意：Pio 组件需要放在 body 标签内，但要在其他内容之前 -->
        <!-- 如果启用了侧边栏，可能需要调整 z-index -->
        {pioConfig.enable && <Pio client:load />}

        <!-- increase the page height during page transition to prevent the scrolling animation from jumping -->
        <div id="page-height-extend" class="hidden h-[300vh]"></div>

        <!-- Translate.js integration - lazy loading -->
        {siteConfig.translate?.enable && (
            <script>
                window.loadTranslateScript = function() {
                    if (window.translateScriptLoaded) {
                        return Promise.resolve();
                    }
                    if (window.translate || document.getElementById('translate-script')) {
                        window.translateScriptLoaded = true;
                        return Promise.resolve();
                    }
                    return new Promise((resolve, reject) => {
                        const script = document.createElement('script');
                        script.src = '/translate.js';
                        script.id = 'translate-script';
                        script.async = true;
                        script.onload = () => {
                            if (typeof window.translate !== 'undefined') {
                                window.translateScriptLoaded = true;
                                resolve();
                            } else {
                                reject(new Error('translate.js loaded but window.translate not available'));
                            }
                        };
                        script.onerror = reject;
                        document.head.appendChild(script);
                    });
                };
            </script>
        )}
    </body>
</html>

<style is:global define:vars={{
    bannerOffset,
    'banner-height-home': `${BANNER_HEIGHT_HOME}vh`,
    'banner-height': `${BANNER_HEIGHT}vh`,
}}>
@tailwind components;
@layer components {
    .enable-banner.is-home #banner-wrapper {
        @apply h-[var(--banner-height-home)] translate-y-[var(--banner-height-extend)]
    }
    .enable-banner #banner-wrapper {
        @apply h-[var(--banner-height-home)]
    }
    .enable-banner.is-home #banner {
        @apply h-[var(--banner-height-home)] translate-y-0
    }
    .enable-banner #banner {
        @apply h-[var(--banner-height-home)] translate-y-[var(--bannerOffset)]
    }
    .enable-banner.is-home #main-grid {
        @apply translate-y-[var(--banner-height-extend)];
    }
    .enable-banner #top-row {
        @apply h-[calc(var(--banner-height-home)_-_4.5rem)] transition-all duration-300
    }
    .enable-banner.is-home #sidebar-sticky {
        @apply top-[calc(1rem_-_var(--banner-height-extend))]
    }
    .navbar-hidden {
        @apply opacity-0 -translate-y-16
    }
}
</style>

<script>
import {
    BANNER_HEIGHT,
    BANNER_HEIGHT_HOME,
    BANNER_HEIGHT_EXTEND,
} from "@/constants/constants";
import { BREAKPOINT_LG } from "@constants/breakpoints";
import {getHue, getStoredTheme, setHue, setTheme} from "@utils/setting-utils";
import {pathsEqual, url} from "@utils/url-utils";
import { siteConfig, particleConfig } from '@/config';
import { initParticle } from "@/utils/particle-manager";
import 'overlayscrollbars/overlayscrollbars.css';


const bannerEnabled = !!document.getElementById('banner-wrapper')

function setClickOutsideToClose(panel: string, ignores: string[]) {
    document.addEventListener("click", event => {
        let panelDom = document.getElementById(panel);
        let tDom = event.target;
        if (!(tDom instanceof Node)) return;		// Ensure the event target is an HTML Node
        for (let ig of ignores) {
            let ie = document.getElementById(ig)
            if (ie == tDom || (ie?.contains(tDom))) {
                return;
            }
        }
        panelDom!.classList.add("float-panel-closed");
    });
}
setClickOutsideToClose("display-setting", ["display-setting", "display-settings-switch"])
setClickOutsideToClose("nav-menu-panel", ["nav-menu-panel", "nav-menu-switch"])
setClickOutsideToClose("search-panel", ["search-panel", "search-bar", "search-switch"])

function loadTheme() {
    const theme = getStoredTheme()
    setTheme(theme)
}

function loadHue() {
    setHue(getHue())
}

function initCustomScrollbar() {
    // 完全禁用OverlayScrollbars的body初始化，避免导致页面重新加载
    // 只处理katex元素的滚动条
    const katexElements = document.querySelectorAll('.katex-display:not([data-scrollbar-initialized])') as NodeListOf<HTMLElement>;
    katexElements.forEach(element => {
        if (!element.parentNode) return;
        const container = document.createElement('div');
        container.className = 'katex-display-container';
        element.parentNode.insertBefore(container, element);
        container.appendChild(element);
        // 使用简单的CSS滚动条而不是OverlayScrollbars
        container.style.cssText = `
            overflow-x: auto;
            scrollbar-width: thin;
            scrollbar-color: rgba(0,0,0,0.3) transparent;
        `;
        // 为webkit浏览器添加自定义滚动条样式
        const style = document.createElement('style');
        style.textContent = `
            .katex-display-container::-webkit-scrollbar {
                height: 6px;
            }
            .katex-display-container::-webkit-scrollbar-track {
                background: transparent;
            }
            .katex-display-container::-webkit-scrollbar-thumb {
                background: rgba(0,0,0,0.3);
                border-radius: 3px;
            }
            .katex-display-container::-webkit-scrollbar-thumb:hover {
                background: rgba(0,0,0,0.5);
            }
        `;
        if (!document.head.querySelector('style[data-katex-scrollbar]')) {
            style.setAttribute('data-katex-scrollbar', 'true');
            document.head.appendChild(style);
        }
        element.setAttribute('data-scrollbar-initialized', 'true');
    });
}

function initTranslate() {
    if (!siteConfig.translate?.enable || !window.translate || window.translateInitialized) return;
    // 配置translate.js
    if (siteConfig.translate.service) {
        window.translate.service.use(siteConfig.translate.service);
    }
    if (siteConfig.translate.defaultLanguage) {
        window.translate.language.setLocal(siteConfig.translate.defaultLanguage);
    }
    if (siteConfig.translate.autoDiscriminate) {
        window.translate.setAutoDiscriminateLocalLanguage();
    }
    // 设置忽略的类名和标签
    if (siteConfig.translate.ignoreClasses) {
        siteConfig.translate.ignoreClasses.forEach(className => {
            window.translate?.ignore.class.push(className);
        });
    }
    if (siteConfig.translate.ignoreTags) {
        siteConfig.translate.ignoreTags.forEach(tagName => {
            window.translate?.ignore.tag.push(tagName);
        });
    }
    // 不显示默认的select选择框
    if (siteConfig.translate.showSelectTag === false) {
        window.translate.selectLanguageTag.show = false;
    }
    // 禁用自动保存翻译状态到localStorage
    window.translate.storage.set = function() {
        // 空函数，阻止保存状态
    };
    // 启动翻译监听
    window.translate.listener.start();
    // 标记已初始化
    window.translateInitialized = true;
    // 执行翻译初始化
    window.translate?.execute();
}

// 懒加载并初始化翻译功能
async function loadAndInitTranslate() {
    if (!siteConfig.translate?.enable) return;

    try {
        await window.loadTranslateScript?.();
        initTranslate();
    } catch (error) {
        console.error('Failed to load translate.js:', error);
    }
}

// 页面加载完成后自动初始化翻译
if (siteConfig.translate?.enable) {
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', loadAndInitTranslate);
    } else {
        loadAndInitTranslate();
    }
}

// 初始化粒子特效
function setupParticle() {
    if (!particleConfig || !particleConfig.enable) return;
    if ((window as any).particleInitialized) return;
    initParticle(particleConfig);
    (window as any).particleInitialized = true;
}

// 页面加载完成后自动初始化粒子特效
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', setupParticle);
} else {
    setupParticle();
}

// 初始化Swup
const setup = () => {
    // Swup can update the body for each page visit, but it's after the page transition, causing a delay for banner height change, so use Swup hooks instead to change the height immediately when a link is clicked
    window.swup.hooks.on('link:click', () => {
        // Remove the delay for the first time page load
        document.documentElement.style.setProperty('--content-delay', '0ms')
        // 简化navbar处理逻辑
        if (bannerEnabled) {
            const navbar = document.getElementById('navbar-wrapper')
            if (navbar && document.body.classList.contains('lg:is-home')) {
                const threshold = window.innerHeight * (BANNER_HEIGHT / 100) - 88
                if (document.documentElement.scrollTop >= threshold) {
                    navbar.classList.add('navbar-hidden')
                }
            }
        }
    })
    window.swup.hooks.on('content:replace', () => {
        // 只处理新的katex元素的滚动条，使用原生CSS滚动条
        initCustomScrollbar();
        // 检查当前页面是否为文章页面（有TOC元素）
        const tocWrapper = document.getElementById('toc-wrapper');
        const isArticlePage = tocWrapper !== null;
        // 只在文章页面重新初始化 TOC 组件
        if (isArticlePage) {
            const tocElement = document.querySelector('table-of-contents');
            if (tocElement && typeof (tocElement as any).init === 'function') {
                setTimeout(() => {
                    (tocElement as any).init();
                }, 100);
            }
            // 重新初始化移动端 TOC 组件
            if (typeof (window as any).mobileTOCInit === 'function') {
                setTimeout(() => {
                    (window as any).mobileTOCInit();
                }, 100);
            }
        }
        // 页面内容替换后重新执行翻译（仅在翻译已加载时）
        if (siteConfig.translate?.enable && window.translateInitialized && window.translate) {
            // 使用requestAnimationFrame优化性能，减少延迟
            requestAnimationFrame(() => {
                window.translate?.execute();
            });
        }
        // 重新初始化semifull模式的滚动检测
        const navbar = document.getElementById('navbar')
        if (navbar) {
            const transparentMode = navbar.getAttribute('data-transparent-mode')
            if (transparentMode === 'semifull') {
                // 重新调用初始化函数来重新绑定滚动事件
                if (typeof (window as any).initSemifullScrollDetection === 'function') {
                    (window as any).initSemifullScrollDetection()
                }
            }
        }
    })
    window.swup.hooks.on('visit:start', (visit: {to: {url: string}}) => {
        // change banner height immediately when a link is clicked
        const bodyElement = document.querySelector('body')
        const isHomePage = pathsEqual(visit.to.url, url('/'))
        if (isHomePage) {
            bodyElement!.classList.add('lg:is-home');
        } else {
            bodyElement!.classList.remove('lg:is-home');
        }
        // Control banner text visibility based on page
        const bannerTextOverlay = document.querySelector('.banner-text-overlay')
        if (bannerTextOverlay) {
            if (isHomePage) {
                bannerTextOverlay.classList.remove('hidden')
            } else {
                bannerTextOverlay.classList.add('hidden')
            }
        }
        // Control navbar transparency based on page
        const navbar = document.getElementById('navbar')
        if (navbar) {
            navbar.setAttribute('data-is-home', isHomePage.toString())
            // 重新初始化semifull模式的滚动检测
            const transparentMode = navbar.getAttribute('data-transparent-mode')
            if (transparentMode === 'semifull') {
                // 重新调用初始化函数来重新绑定滚动事件
                if (typeof window.initSemifullScrollDetection === 'function') {
                    window.initSemifullScrollDetection()
                }
            }
        }
        // Control mobile banner visibility based on page with improved staging animation
        const bannerWrapper = document.getElementById('banner-wrapper')
        const mainContentWrapper = document.querySelector('.absolute.w-full.z-30')
        if (bannerWrapper && mainContentWrapper) {
            if (isHomePage) {
                // 首页：延迟移除隐藏类，让banner和内容优雅地出现
                setTimeout(() => {
                    bannerWrapper.classList.remove('mobile-hide-banner')
                }, 100)
                setTimeout(() => {
                    mainContentWrapper.classList.remove('mobile-main-no-banner')
                }, 150)
            } else {
                // 非首页：分阶段隐藏，先隐藏banner，再移动内容
                bannerWrapper.classList.add('mobile-hide-banner')
                // 延迟移动内容，让banner先完全消失
                setTimeout(() => {
                    mainContentWrapper.classList.add('mobile-main-no-banner')
                }, 100)
            }
        }
        // increase the page height during page transition to prevent the scrolling animation from jumping
        const heightExtend = document.getElementById('page-height-extend')
        if (heightExtend) {
            heightExtend.classList.remove('hidden')
        }
        // Hide the TOC while scrolling back to top
        let toc = document.getElementById('toc-wrapper');
        if (toc) {
            toc.classList.add('toc-not-ready')
        }
    });
    window.swup.hooks.on('page:view', () => {
        // hide the temp high element when the transition is done
        const heightExtend = document.getElementById('page-height-extend')
        if (heightExtend) {
            heightExtend.classList.remove('hidden')
        }
        // 确保页面滚动到顶部，特别是移动端banner关闭时
        window.scrollTo({
            top: 0,
            behavior: 'instant'
        });
        // 检查当前页面是否为文章页面，如果是则触发自定义事件用于初始化评论系统
        setTimeout(() => {
            if (document.getElementById('tcomment')) {
                // 触发自定义事件，通知评论系统页面已完全加载
                const pageLoadedEvent = new CustomEvent('twilight:page:loaded', {
                    detail: {
                        path: window.location.pathname,
                        timestamp: Date.now()
                    }
                });
                document.dispatchEvent(pageLoadedEvent);
                console.log('Layout: 触发 twilight:page:loaded 事件，路径:', window.location.pathname);
            }
        }, 300);
    });
    window.swup.hooks.on('visit:end', (_visit: {to: {url: string}}) => {
        setTimeout(() => {
            const heightExtend = document.getElementById('page-height-extend')
            if (heightExtend) {
                heightExtend.classList.add('hidden')
            }
            // Just make the transition looks better
            const toc = document.getElementById('toc-wrapper');
            if (toc) {
                toc.classList.remove('toc-not-ready')
            }
        }, 200)
    });
}
if (window?.swup?.hooks) {
    setup()
} else {
    document.addEventListener('swup:enable', setup)
}

let backToTopBtn = document.getElementById('back-to-top-btn');
let toc = document.getElementById('toc-wrapper');
let navbar = document.getElementById('navbar-wrapper')

// 节流函数
function throttle(func: (...args: any[]) => void, limit: number) {
    let inThrottle: boolean;
    return function(this: any, ...args: any[]) {
        if (!inThrottle) {
            func.apply(this, args);
            inThrottle = true;
            setTimeout(() => inThrottle = false, limit);
        }
    }
}

function scrollFunction() {
    const scrollTop = document.documentElement.scrollTop;
    const bannerHeight = window.innerHeight * (BANNER_HEIGHT / 100);

    // 批量处理DOM操作
    requestAnimationFrame(() => {
        if (backToTopBtn) {
            if (scrollTop > bannerHeight) {
                backToTopBtn.classList.remove('hide')
            } else {
                backToTopBtn.classList.add('hide')
            }
        }
        if (bannerEnabled && toc) {
            if (scrollTop > bannerHeight) {
                toc.classList.remove('toc-hide')
            } else {
                toc.classList.add('toc-hide')
            }
        }
        if (bannerEnabled && navbar) {
            const isHome = document.body.classList.contains('lg:is-home') && window.innerWidth >= BREAKPOINT_LG;
            const currentBannerHeight = isHome ? BANNER_HEIGHT_HOME : BANNER_HEIGHT;
            const threshold = window.innerHeight * (currentBannerHeight / 100) - 88;
            if (scrollTop >= threshold) {
                navbar.classList.add('navbar-hidden')
            } else {
                navbar.classList.remove('navbar-hidden')
            }
        }
    });
}

// 使用节流优化滚动性能
window.onscroll = throttle(scrollFunction, 16); // 约60fps

window.onresize = () => {
    // calculate the --banner-height-extend, which needs to be a multiple of 4 to avoid blurry text
    let offset = Math.floor(window.innerHeight * (BANNER_HEIGHT_EXTEND / 100));
    offset = offset - offset % 4;
    document.documentElement.style.setProperty('--banner-height-extend', `${offset}px`);
}

</script>

<script>
import PhotoSwipeLightbox from "photoswipe/lightbox"
import "photoswipe/style.css"

let lightbox: PhotoSwipeLightbox

function createPhotoSwipe() {
    lightbox = new PhotoSwipeLightbox({
        gallery: ".custom-md img, #post-cover img, .moment-images img",
        pswpModule: () => import("photoswipe"),
        closeSVG: '<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#ffffff"><path d="M480-424 284-228q-11 11-28 11t-28-11q-11-11-11-28t11-28l196-196-196-196q-11-11-11-28t11-28q11-11 28-11t28 11l196 196 196-196q11-11 11-28t-11-28q-11-11-28-11t-28 11L480-424Z"/></svg>',
        zoomSVG: '<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#ffffff"><path d="M340-540h-40q-17 0-28.5-11.5T260-580q0-17 11.5-28.5T300-620h40v-40q0-17 11.5-28.5T380-700q17 0 28.5 11.5T420-660v40h40q17 0 28.5 11.5T500-580q0 17-11.5 28.5T460-540h-40v40q0 17-11.5 28.5T380-460q-17 0-28.5-11.5T340-500v-40Zm0-80q75 0 127.5-52.5T560-580q0-75-52.5-127.5T380-760q-75 0-127.5 52.5T200-580q0 75 52.5 127.5T380-400Z"/></svg>',
        padding: { top: 20, bottom: 20, left: 20, right: 20 },
        wheelToZoom: true,
        arrowPrev: false,
        arrowNext: false,
        imageClickAction: 'close',
        tapAction: 'close',
        doubleTapAction: 'zoom',
    })
    // Add filter BEFORE lightbox is initialized
    lightbox.addFilter("domItemData", (itemData, element) => {
        if (element instanceof HTMLImageElement) {
            itemData.src = element.src
            itemData.w = Number(element.naturalWidth || window.innerWidth)
            itemData.h = Number(element.naturalHeight || window.innerHeight)
            itemData.msrc = element.src
        }
        return itemData
    })
    // Initialize lightbox AFTER adding filters
    lightbox.init()
}

const setup = () => {
    if (!lightbox) {
        createPhotoSwipe()
    }
    window.swup.hooks.on("page:view", () => {
        createPhotoSwipe()
    })
    window.swup.hooks.on(
        "content:replace",
        () => {
            lightbox?.destroy?.()
        },
        { before: true },
    )
}

if (window.swup) {
    setup()
} else {
    document.addEventListener("swup:enable", setup)
}
</script>